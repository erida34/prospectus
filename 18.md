### Глава 18: Обновления серверов

#### 18.1 Основы
1. **Составьте контрольный список служб**:
   - Какие службы предоставлялись сервером?
   - Кто является пользователем каждой службы?
   - Какие программы предоставляли каждую службу?
2. **Проверьте совместимость программ с новой ОС**.
3. **Разработайте тесты для проверки работоспособности каждой службы**.
4. **Напишите план отмены с конкретными условиями**.
5. **Выберите технический перерыв**.
6. **Объявите об обновлении**.
7. **Выполните тесты**.
8. **Заблокируйте пользователей**.
9. **Проведите обновление с наблюдением**.
10. **Повторите тесты**.
11. **Выполните план отмены при необходимости**.
12. **Разблокируйте пользователей**.
13. **Сообщите пользователям о завершении/отмене обновления**.
14. **Проанализируйте результаты и обновите контрольный список**.

#### 18.1.1 Этап 1: Составьте контрольный список служб
- **Контрольный список служб**:
  - Какие службы предоставляются узлом?
  - Кто пользуется каждой службой?
  - Какая программа предоставляет каждую службу?
- **Электронные таблицы**: Удобный способ представления информации.
- **Проверка зависимости пользователей**: Включите пользователей в процесс планирования.
- **Что находится на машине**: Проверьте установленные программы и процессы.
- **Зависимости служб**: Зафиксируйте все взаимозависимости в контрольном списке.
- **Ключевые пользователи**: Определите и уведомите ключевых пользователей.

#### 18.1.2 Этап 2: Проверьте совместимость программ
- Убедитесь, что каждая программа сможет работать с новой ОС.
- Свяжитесь с разработчиками для подтверждения совместимости.
- Проверьте информацию на веб-сайтах разработчиков.
- Самостоятельное тестирование может быть дорогим, но снижает риск неудачи.
- Зафиксируйте источник информации о совместимости.
- Если программа не поддерживается новой ОС, рассмотрите обновление до версии, поддерживаемой обеими ОС.
- Планируйте обновление программы после обновления ОС, если это необходимо.
- Если продукт больше не поддерживается, рассмотрите смену поставщика или отказ от продукта.

#### 18.1.3 Этап 3: Тесты для проверки
- Разработайте тесты для проверки работоспособности служб после обновления.
- Автоматизируйте тесты с помощью скриптов.
- Используйте регрессивное тестирование для сравнения результатов.
- Проверяйте тесты так же подробно, как и службы.
- Автоматизированные тесты предпочтительны, но не всегда возможны.
- Разработка через тестирование (TDD) обеспечивает создание тестов для всего нового кода.
- Сохраняйте тесты для дальнейшего использования и мониторинга.

#### 18.1.4 Этап 4: Напишите план отмены
- Определите, как вернуться к предыдущему состоянию в случае неудачи.
- Установите конкретное время для задействования плана отмены.
- Создайте резервные копии системы перед обновлением.
- Планируйте отмену в случае неудачного выполнения ключевых тестов или непредвиденных ситуаций.

#### 18.1.5 Этап 5: Выберите технический перерыв
- Согласуйте с пользователями время для обновления.
- Оцените продолжительность обновления и плана отмены.
- Объявите перерыв длиннее, чем ожидаемое время.
- Установите точное время для задействования плана отмены.

#### 18.1.6 Этап 6: Сообщите об обновлении
- Используйте стандартный формат для объявлений.
- Сообщение должно быть кратким и по теме.
- Укажите, кого затронет обновление, что произойдет, когда и зачем.
- Предоставьте контактную информацию для возражений.

#### 18.1.7 Этап 7: Выполните тесты
- Выполните тесты перед началом обновления, чтобы убедиться в отсутствии проблем до обновления.

#### 18.1.8 Этап 8: Заблокируйте пользователей
- Позвольте пользователям выйти из системы самостоятельно.
- Используйте средства ОС для предотвращения входа в систему во время технического перерыва.

#### 18.1.9 Этап 9: Выполните обновление под чьим-нибудь наблюдением
- Выполните обновление в соответствии с местными процедурами.
- Обновления важны для выполнения вдвоем для минимизации ошибок и обучения.
- Обратитесь за помощью к коллегам или старшим сотрудникам при необходимости.

#### 18.1.10 Этап 10: Проверьте свою работу
- Повторите все ранее созданные тесты.
- Привлекайте пользователей для проверки завершения обновления.

#### 18.1.11 Этап 11: Если ничего не получилось, выполните план отмены
- Начните выполнение плана отмены, если обновление занимает больше времени или тесты не выполняются.
- Зафиксируйте результаты изменений в контрольном списке.

#### 18.1.12 Этап 12: Восстановите доступ пользователей
- Разрешите пользователям снова начать работать с системой.
- Используйте различные способы для проверки без разрешения всем пользователям доступа.

#### 18.1.13 Этап 13: Сообщите о завершении/отмене
- Сообщите пользователям о завершении обновления или отмене.
- Укажите, какие системы или службы снова работают, и предоставьте контактную информацию для сообщения о проблемах.

#### 18.2 Тонкости

#### 18.2.1 Добавляйте и удаляйте службы одновременно
- Добавление и удаление служб одновременно усложняет процесс.
- Отладка системы с двумя изменениями требует особых тестов.
- Удаление службы может быть простым, но требует проверки на отсутствие зависимостей.
- Отключайте службу так, чтобы ее можно было быстро снова активировать.

#### 18.2.2 Полная установка
- Иногда лучше переустановить систему полностью, чем обновлять ее.
- Полная установка на временной машине позволяет выполнить обновление без отключения старой системы.
- Машина для установки должна быть идентична обновляемой машине.

#### 18.2.3 Повторное использование тестов
- Хорошо написанные тесты можно интегрировать в систему мониторинга реального времени.
- Тестирование нагрузки часто невозможно выполнить на работающей системе.

#### 18.2.4 Запись изменений системы
- Ведите лог изменений для построения контрольного списка служб.
- Храните логи изменений в википедии или на общем файловом сервере.
- Установите правила для хранения логов изменений.

#### 18.2.5 Генеральная репетиция
- Проведите генеральную репетицию обновления на другой машине.
- Генеральная репетиция помогает оценить время и выявить неожиданные препятствия.
- Технические репетиции полезны для рассмотрения задачи всеми заинтересованными сторонами.
- Имитируйте замену кабелей и другие физические изменения.

#### 18.2.6 Установка старых и новых версий на одной машине
- Удобно оставлять старые версии служб на машине в отключенном состоянии при обновлении одной службы.
- Веб-сервер Apache под UNIX позволяет использовать символические ссылки для переключения между версиями.
- В некоторых случаях старая и новая версии программы могут работать одновременно.

#### 18.2.7 Минимальные изменения первоначальной версии
- Минимизируйте изменения системы, загружая пакеты обновлений в отдельный раздел.
- Документируйте изменения в файле CHANGELOG.
- Копируйте директорию /etc перед обновлением для справки.
- Используйте системы контроля версий для отслеживания изменений в файлах конфигурации.

#### 18.3 Заключение
- Контрольный список – основное средство для обновления.
- Контрольный список используется для определения служб, времени обновления и тестов.
- Тесты могут использоваться до и после обновления для обеспечения качества.
- Планы отмены включены в контрольный список.
- Контрольный список поддерживает единство группы и помогает пользователям понимать процесс.
- Автоматизированные тесты должны быть интегрированы в системы мониторинга реального времени.
- Процесс обновления должен быть простым и воспроизводимым.
- Возможность возврата к предыдущему состоянию важна для поддержания целостности систем.
